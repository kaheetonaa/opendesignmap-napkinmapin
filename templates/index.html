<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.12.0/css/ol.css" type="text/css">
    <title>Freehand Drawing</title>
    <style>
      .map {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      z-index: -1;
      }
      .form-inline {
      position: fixed;
      bottom: 30px;
      left: 20px; 
      z-index: 0;
      }
      .title {
      position: absolute;
      bottom: 60px;
      left: 20px; 
      z-index: 0;
      }
    </style>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.12.0/build/ol.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div class="title">
    <b> Mappin Napkin </b> <br>
    <label for="fname">First name:</label> <input type="text" id="fname" name="fname"><br>
    <button id="geojsonbutton">geojson button</button>
  </div>
    <form class="form-inline">
      
      <label for="type">Geometry type &nbsp;</label>
      <select id="type">
        <option value="None">None</option>
        <option value="Extent">Extent</option>
        <option value="LineString">LineString</option>
        <option value="Polygon">Polygon</option>
        <option value="Circle">Circle</option>
      </select>
      </form>
<script type="module">

const source = new ol.source.Vector({wrapX: false});
const source_extent = new ol.source.Vector({wrapX: false});

const extent = new ol.layer.Vector({
  source: source_extent,
  opacity:0.3,
});


const canvas = document.createElement('canvas');
const context = canvas.getContext('2d');

var extent_img = new Image();
extent_img.src = 'https://st2.depositphotos.com/3769671/7957/v/600/depositphotos_79574646-stock-illustration-paper-texture-template.jpg'; // your image here
extent_img.onload = function() {
  var extent_pattern = context.createPattern(extent_img, 'repeat');

    extent.setStyle(new ol.style.Style({
       fill: new ol.style.Fill({
         color: extent_pattern
       }),
        stroke: new ol.style.Stroke({
      color: 'rgba(255,255,255,0)'
    }),
        zIndex:1,

    }));
  }

const attributions =
  '<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>';


const raster = new ol.layer.Tile({
  source: new ol.source.XYZ({
        attributions: attributions,
        url:
          'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
        maxZoom: 20,
      })
});


const vector = new ol.layer.Vector({
  source: source,
    style: new ol.style.Style({
    zIndex:2,
    fill: new ol.style.Fill({
      color: 'rgba(255,255,255,0.1)'
    }),
    stroke: new ol.style.Stroke({
      color: 'black'
    })
  })
});



const map = new ol.Map({
  layers: [raster,extent,vector],
  target: 'map',
  view: new ol.View({
    center: [-11000000, 4600000],
    zoom: 4,
  }),
});

const typeSelect = document.getElementById('type');

addInteraction();

let draw; // global so we can remove it later
function addInteraction() {
  const value = typeSelect.value;

  switch (value){
  case 'None':
  break;
  case 'Extent':
  draw = new ol.interaction.Draw({
      source: source_extent,
      type: 'Circle',
      geometryFunction:ol.interaction.Draw.createBox(),
      freehand: false,
    });
  map.addInteraction(draw);
  break;
  default:
    draw = new ol.interaction.Draw({
      source: source,
      type: typeSelect.value,
      freehand: true,
    });
    map.addInteraction(draw);
  break;
  }
}

/**
 * Handle change event.
 */
typeSelect.onchange = function () {
  map.removeInteraction(draw);
  addInteraction();
  console.log(extent);
};

geojsonbutton.onclick=function() {
    var writer = new ol.format.GeoJSON();
    var geojsonStr = writer.writeFeatures(source.getFeatures());
    download_geojson(geojsonStr)
};

function download_geojson(geojsonStr) {
    var a = document.createElement("a");
    var file = new Blob([geojsonStr], {type: "application/json"});
    a.href = URL.createObjectURL(file);
    a.download = "geojson";
    a.click();
  }

</script>
  </body>
</html>
