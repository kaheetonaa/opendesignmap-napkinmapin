<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.12.0/css/ol.css" type="text/css">
    <title>Freehand Drawing</title>
    <style>
      .linestring-button {
        top: 12.5em;
        left: 0.5em;
      }
      .polygon-button {
        top: 15em;
        left: 0.5em;
      }
      .extent-button {
        top: 10em;
        left: 0.5em;
      }
      .map {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      z-index: -1;
      }
      .form-inline {
      position: fixed;
      bottom: 30px;
      left: 20px; 
      z-index: 0;
      }
      .title {
      position: absolute;
      bottom: 60px;
      left: 20px; 
      z-index: 0;
      }
    </style>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.12.0/build/ol.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div class="title">
    <b> Mappin Napkin </b> <br>
    <button id="geojsonbutton">geojson button</button>
  </div>
<script type="module">
let draw; // global so we can remove it later
var typeSelect = document.getElementById('type');
let type="None";

class linestring_button extends ol.control.Control {
  /**
   * @param {Object} [opt_options] Control options.
   */
  constructor(opt_options) {
    const options = opt_options || {};

    const button = document.createElement("button");
    button.innerHTML = "â•±";
    button.id='linestringbutton';

    const element = document.createElement("div");
    element.className = "linestring-button ol-unselectable ol-control";
    element.appendChild(button);

    super({
      element: element,
      target: options.target
    });

    button.addEventListener("click",  ()=>{type="LineString"}, false);
  }
}

class polygon_button extends ol.control.Control {
  /**
   * @param {Object} [opt_options] Control options.
   */
  constructor(opt_options) {
    const options = opt_options || {};

    const button = document.createElement("button");
    button.innerHTML = "âƒ¤";
    button.id='polygonbutton';

    const element = document.createElement("div");
    element.className = "polygon-button ol-unselectable ol-control";
    element.appendChild(button);

    super({
      element: element,
      target: options.target
    });

    button.addEventListener("click", ()=>{type="Polygon";}, false);
  }
}

class extent_button extends ol.control.Control {
  /**
   * @param {Object} [opt_options] Control options.
   */
  constructor(opt_options) {
    const options = opt_options || {};

    const button = document.createElement("button");
    button.innerHTML = "ðŸ“„";
    button.id='extentbutton';

    const element = document.createElement("div");
    element.className = "extent-button ol-unselectable ol-control";
    element.appendChild(button);

    super({
      element: element,
      target: options.target
    });

    button.addEventListener("click", ()=>{type="Extent"}, false);
  }
}


const source = new ol.source.Vector({wrapX: true});
const source_extent = new ol.source.Vector({wrapX: true});

const extent = new ol.layer.VectorImage({
  source: source_extent,
  opacity:0.75,
});


const canvas = document.createElement('canvas');
const context = canvas.getContext('2d');

var extent_img = new Image();
extent_img.src = 'https://st2.depositphotos.com/3769671/7957/v/600/depositphotos_79574646-stock-illustration-paper-texture-template.jpg'; // your image here
extent_img.onload = function() {
  var extent_pattern = context.createPattern(extent_img, 'repeat');

    extent.setStyle(new ol.style.Style({
       fill: new ol.style.Fill({
         color: extent_pattern
       }),
        stroke: new ol.style.Stroke({
      color: 'rgba(255,255,255,0)'
    }),
        zIndex:1,

    }));
  }

const attributions =
  '<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>';


const raster = new ol.layer.Tile({
  source: new ol.source.XYZ({
        attributions: attributions,
        url:
          'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
        maxZoom: 20,
      })
});


const vector = new ol.layer.VectorImage({
  source: source,
    style: new ol.style.Style({
    zIndex:2,
    fill: new ol.style.Fill({
      color: 'rgba(0,0,0,0.5)'
    }),
    stroke: new ol.style.Stroke({
      color: 'black'
    })
  })
});



const map = new ol.Map({
  controls: ol.control.defaults().extend([
    new linestring_button(),
    new extent_button(),
    new polygon_button(),
  ]),
  layers: [raster,extent,vector],
  target: 'map',
  view: new ol.View({
    projection:'EPSG:3857',
    center: [105,21],
    zoom: 4,
  }),
});

addInteraction();

function addInteraction() {
  const value = type; //typeSelect.value;
  console.log(type);
  switch (value){
  case 'None':
  break;
  case 'Extent':
  draw = new ol.interaction.Draw({
      source: source_extent,
      type: 'Circle',
      geometryFunction:ol.interaction.Draw.createBox(),
      freehand: false,
    });
      
  
   // draw end set properties test
   //drawend event
draw.on('drawend', function(e) {
  e.feature.setProperties({
    'id': 1234,
    'name': 'yourCustomName'
  })
  console.log(e.feature, e.feature.getProperties());
  map.removeInteraction(draw);
  });
  
  //add draw to map
  map.addInteraction(draw);
  break;
  default:
    draw = new ol.interaction.Draw({
      source: source,
      type: type,
      freehand: true,
    });
    map.addInteraction(draw);
      
    //drawend event
draw.on('drawend', function(e) {
  e.feature.setProperties({
    'id': 1234,
    'name': 'yourCustomName'
  })
  console.log(e.feature, e.feature.getProperties());
  });
  break;
  }
  
}

/**
 * Handle change event.
 */
extentbutton.onclick=function() {
  map.removeInteraction(draw);
  addInteraction();
};

linestringbutton.onclick=function() {
  map.removeInteraction(draw);
  addInteraction();
};

polygonbutton.onclick=function() {
  map.removeInteraction(draw);
  addInteraction();
};

geojsonbutton.onclick=function() {
    var writer = new ol.format.GeoJSON({featureProjection:'EPSG:3857'});
    var geojsonStr = writer.writeFeatures(source.getFeatures());
    console.log(geojsonStr);
    download_geojson(geojsonStr);
    
};

function download_geojson(geojsonStr) {
    var a = document.createElement("a");
    var file = new Blob([geojsonStr], {type: "application/json"});
    a.href = URL.createObjectURL(file);
    a.download = "geojson";
    a.click();
  }

</script>
  </body>
</html>
